#!/bin/bash

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è myhelper.uz

SERVER="root@95.46.96.147"
DOMAIN="myhelper.uz"

echo "üîí –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è $DOMAIN"
echo "=================================================="
echo ""
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï:"
echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ DNS –∑–∞–ø–∏—Å–∏ myhelper.uz —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ 95.46.96.147"
echo "2. –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤–≤–µ—Å—Ç–∏ email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç Let's Encrypt"
echo "3. –°–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"
echo ""
read -p "–ù–∞–∂–º–∏—Ç–µ Enter —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å..."

echo ""
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot..."
ssh -o StrictHostKeyChecking=no $SERVER << 'ENDSSH'
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot
apt update -qq
apt install certbot python3-certbot-nginx -y

if [ $? -eq 0 ]; then
    echo "‚úÖ Certbot —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ Certbot"
    exit 1
fi
ENDSSH

echo ""
echo "üîê –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
echo ""
echo "‚ö†Ô∏è  Certbot –∑–∞–¥–∞—Å—Ç –≤–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤:"
echo "   1. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"
echo "   2. –°–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ (Y)"
echo "   3. –†–∞–∑—Ä–µ—à–∏—Ç–µ/–∑–∞–ø—Ä–µ—Ç–∏—Ç–µ —Ä–∞—Å—Å—ã–ª–∫—É –Ω–æ–≤–æ—Å—Ç–µ–π (N)"
echo ""

# –ó–∞–ø—É—Å–∫ certbot (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)
ssh -t -o StrictHostKeyChecking=no $SERVER "certbot --nginx -d $DOMAIN -d www.$DOMAIN"

if [ $? -eq 0 ]; then
    echo ""
    echo "=================================================="
    echo "‚úÖ SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢ –£–°–¢–ê–ù–û–í–õ–ï–ù!"
    echo "=================================================="
    echo ""
    echo "üåê –°–∞–π—Ç —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å–∞–º:"
    echo "   https://myhelper.uz"
    echo "   https://www.myhelper.uz"
    echo ""
    echo "üîÑ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è"
    echo ""
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ SSL"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "1. DNS –∑–∞–ø–∏—Å–∏ –Ω–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
    echo "2. –ü–æ—Ä—Ç 80 –∏–ª–∏ 443 –∑–∞–∫—Ä—ã—Ç —Ñ–∞–π—Ä–≤–æ–ª–æ–º"
    echo "3. Nginx –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    echo ""
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:"
    echo "  nslookup myhelper.uz"
    echo "  ssh $SERVER 'systemctl status nginx'"
fi
